---
- name: Converge
  hosts: master-1
  gather_facts: true
  tasks:
    - name: "Include global tasks"
      include_role:
        name: "k8s"  
    - name: Load variable file
      include_vars:
        dir: ../../vars
    - name: Get cluster info 
      command: kubectl cluster-info
      register: kubectl
      changed_when: false
    - name: "Create namespace {{ item }}"
      command: "{{ item }}"
      register: kubectl
      changed_when: false
      loop:
        - kubectl create namespace istio-system
        - kubectl create namespace foo
        - kubectl create namespace bar
        - kubectl create namespace legacy
    - name: Create secret generic cacerts
      command: kubectl create secret generic cacerts -n istio-system --from-file=/vagrant/istio/root-cert.pem
      register: kubectl
      changed_when: false
    - name: "Create secret object in {{ item }} namespace"
      command: "{{ item }}"
      register: kubectl
      changed_when: false
      loop:
        - kubectl apply -f /vagrant/k8s/templates/keyfactor-secret-run.yaml -n istio-system 
        - kubectl apply -f /vagrant/k8s/templates/keyfactor-secret-run.yaml -n foo 
        - kubectl apply -f /vagrant/k8s/templates/keyfactor-secret-run.yaml -n bar
        - kubectl apply -f /vagrant/k8s/templates/keyfactor-secret-run.yaml -n legacy
    - name: Install istio single cluster with secret template 
      command: /vagrant/istio/release/istioctl-linux-amd64 manifest --set installPackagePath=/vagrant/istio/installs apply -f /vagrant/k8s/templates/single-cluster-run.yaml
      register: kubectl
      changed_when: false
    - name: Config auto inject label for namespace
      command:  "{{ item }}"
      register: kubectl
      changed_when: false
      loop:
        - kubectl label namespace foo istio-injection=enabled 
        - kubectl label namespace bar istio-injection=enabled 
    - name: "Install httbin test service {{ item }}"
      command:  "{{ item }}"
      register: kubectl
      changed_when: false
      loop:
        - kubectl apply -f /vagrant/k8s/templates/httpbin.yaml -n foo
        - kubectl apply -f /vagrant/k8s/templates/httpbin.yaml -n bar
        - kubectl apply -f /vagrant/k8s/templates/httpbin.yaml -n legacy
    - name: "Install sleep test service {{ item }}"
      command:  "{{ item }}"
      register: kubectl
      changed_when: false
      loop:
        - kubectl apply -f /vagrant/k8s/templates/sleep.yaml -n foo
        - kubectl apply -f /vagrant/k8s/templates/sleep.yaml -n bar
        - kubectl apply -f /vagrant/k8s/templates/sleep.yaml -n legacy
    - name: Install mTLS policy
      command:  kubectl apply -f /vagrant/k8s/templates/mtls-policy.yaml -n istio-system
      register: kubectl
      changed_when: false